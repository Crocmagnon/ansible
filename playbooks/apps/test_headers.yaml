---
- name: Setup test_headers
  hosts: servers
  gather_facts: false
  tasks:
    - name: Create dir
      ansible.builtin.file:
        path: "{{ dir }}"
        state: directory
        mode: "0775"
    - name: Write app.py
      ansible.builtin.copy:
        src: files/test_headers/app.py
        dest: "{{ dir }}/app.py"
        mode: "0644"
        owner: gaugendre
        group: gaugendre
      notify:
        - Restart service
    - name: Write docker-compose.yaml
      ansible.builtin.copy:
        src: files/test_headers/docker-compose.yaml
        dest: "{{ dir }}/docker-compose.yaml"
        mode: "0644"
        owner: gaugendre
        group: gaugendre
    - name: Ensure service is started
      community.docker.docker_compose_v2:
        project_src: "{{ dir }}"
        state: present
  handlers:
    - name: Restart service
      community.docker.docker_compose_v2:
        project_src: "{{ dir }}"
        state: restarted
  vars:
    dir: /mnt/data/test_headers
